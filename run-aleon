#!/bin/bash

################################################################################
# aleon-run.sh - Codespace Setup for open-webui
# Installs everything in /tmp to avoid workspace storage limits
################################################################################

set -e

WORK_DIR="/tmp/aleon-open-webui-workspace"
LOG_FILE="/tmp/aleon-setup.log"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log_info() { echo -e "${BLUE}[INFO]${NC} $*" | tee -a "$LOG_FILE"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $*" | tee -a "$LOG_FILE"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*" | tee -a "$LOG_FILE"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*" | tee -a "$LOG_FILE"; }

################################################################################
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ
################################################################################
check_storage() {
    log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–æ..."
    
    WORKSPACE_SPACE=$(df /workspaces 2>/dev/null | awk 'NR==2 {print int($4/1024)}' || echo "N/A")
    TMP_SPACE=$(df /tmp | awk 'NR==2 {print int($4/1024)}')
    
    echo ""
    echo "üìä –î–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ:"
    echo "  /workspaces: ${WORKSPACE_SPACE}MB"
    echo "  /tmp: ${TMP_SPACE}MB"
    echo ""
    
    if [ "$TMP_SPACE" -lt 5000 ]; then
        log_error "/tmp –∏–º–µ–µ—Ç –º–∞–ª–æ –º–µ—Å—Ç–∞ (${TMP_SPACE}MB)"
        exit 1
    fi
}

################################################################################
# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
################################################################################
setup_workspace() {
    log_info "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –≤ /tmp..."
    
    rm -rf "$WORK_DIR" 2>/dev/null || true
    mkdir -p "$WORK_DIR"
    
    # –ö–æ–ø–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (—Ç–æ–ª—å–∫–æ –∏—Å—Ö–æ–¥–Ω–∏–∫–∏, –±–µ–∑ node_modules –∏ .venv)
    log_info "–ö–æ–ø–∏ÔøΩÔøΩ–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤..."
    cd /workspaces/open-webui
    
    # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã, –∫—Ä–æ–º–µ —Ç—è–∂–µ–ª—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    rsync -av \
        --exclude='node_modules' \
        --exclude='.venv' \
        --exclude='__pycache__' \
        --exclude='.git' \
        --exclude='dist' \
        --exclude='build' \
        . "$WORK_DIR/" 2>/dev/null || cp -r . "$WORK_DIR/"
    
    cd "$WORK_DIR"
    log_success "–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≥–æ—Ç–æ–≤–∞: $WORK_DIR"
}

################################################################################
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js
################################################################################
setup_nodejs() {
    log_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é Node
    if ! command -v node &> /dev/null; then
        log_error "Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        exit 1
    fi
    
    NODE_VERSION=$(node -v)
    NPM_VERSION=$(npm -v)
    log_success "Node.js –≤–µ—Ä—Å–∏—è: $NODE_VERSION"
    log_success "npm –≤–µ—Ä—Å–∏—è: $NPM_VERSION"
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ npm –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ /tmp
    mkdir -p /tmp/npm-cache
    mkdir -p /tmp/npm-global
    
    npm config set cache /tmp/npm-cache
    npm config set prefix /tmp/npm-global
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ npm –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (—ç—Ç–æ –∑–∞–π–º–µ—Ç –≤—Ä–µ–º—è)..."
    npm ci --prefer-offline --no-audit --legacy-peer-deps 2>&1 | tee -a "$LOG_FILE"
    
    log_success "npm –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

################################################################################
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python
################################################################################
setup_python() {
    log_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
    
    if ! command -v python3 &> /dev/null; then
        log_error "Python3 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        exit 1
    fi
    
    PYTHON_VERSION=$(python3 --version)
    log_success "$PYTHON_VERSION"
    
    # –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≤ /tmp
    VENV_PATH="/tmp/aleon-venv"
    rm -rf "$VENV_PATH" 2>/dev/null || true
    
    log_info "–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ $VENV_PATH..."
    python3 -m venv "$VENV_PATH"
    source "$VENV_PATH/bin/activate"
    
    log_info "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ pip, setuptools, wheel..."
    pip install --upgrade pip setuptools wheel --cache-dir /tmp/pip-cache 2>&1 | tail -5
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º requirements.txt
    if [ -f "$WORK_DIR/requirements.txt" ]; then
        log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ requirements.txt..."
        pip install -r requirements.txt --cache-dir /tmp/pip-cache 2>&1 | tee -a "$LOG_FILE"
    elif [ -f "$WORK_DIR/pyproject.toml" ]; then
        log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ pyproject.toml..."
        pip install -e . --cache-dir /tmp/pip-cache 2>&1 | tee -a "$LOG_FILE"
    fi
    
    log_success "Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
    echo "$VENV_PATH" > /tmp/aleon-venv-path.txt
}

################################################################################
# –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
################################################################################
build_app() {
    log_info "–°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    
    if [ -f "package.json" ]; then
        log_info "–ó–∞–ø—É—Å–∫ npm build..."
        npm run build 2>&1 | tee -a "$LOG_FILE" || log_warn "npm build –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏"
    fi
    
    log_success "–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
}

################################################################################
# –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
################################################################################
create_startup_script() {
    local START_SCRIPT="/tmp/aleon-start.sh"
    
    cat > "$START_SCRIPT" << 'STARTUP_EOF'
#!/bin/bash

VENV_PATH=$(cat /tmp/aleon-venv-path.txt 2>/dev/null || echo "/tmp/aleon-venv")
WORK_DIR="/tmp/aleon-open-webui-workspace"

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º Python –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source "$VENV_PATH/bin/activate" 2>/dev/null || true

# –î–æ–±–∞–≤–ª—è–µ–º npm global –≤ PATH
export PATH="/tmp/npm-global/bin:$PATH"

cd "$WORK_DIR"

echo "üöÄ –ó–∞–ø—É—Å–∫ open-webui..."
echo "   –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $WORK_DIR"
echo "   Python venv: $VENV_PATH"
echo ""

# –ó–∞–ø—É—Å–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if [ -f "run.sh" ]; then
    bash run.sh
elif [ -f "run-compose.sh" ]; then
    bash run-compose.sh
else
    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞–ø—É—Å–∫
    if command -v npm &> /dev/null; then
        npm run dev
    else
        python3 -m uvicorn backend.main:app --host 0.0.0.0 --port 8000
    fi
fi
STARTUP_EOF
    
    chmod +x "$START_SCRIPT"
    log_success "–°—Ç–∞—Ä—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω: $START_SCRIPT"
}

################################################################################
# –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞
################################################################################
print_summary() {
    cat << EOF

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë           ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!                      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏: $WORK_DIR
üìù –õ–æ–≥–∏: $LOG_FILE

üöÄ –î–ª—è –∑–∞–ø—É—Å–∫–∞ –æ—Ç–∫—Ä–æ–π –Ω–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –≤—ã–ø–æ–ª–Ω–∏:

    /tmp/aleon-start.sh

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:

    source /tmp/aleon-venv/bin/activate
    export PATH="/tmp/npm-global/bin:\$PATH"
    cd $WORK_DIR
    npm run dev

üíæ –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: /tmp
   Workspace —á–∏—Å—Ç—ã–π!

‚ÑπÔ∏è  –û—á–∏—Å—Ç–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):
   rm -rf $WORK_DIR
   rm -rf /tmp/aleon-venv
   rm -rf /tmp/npm-cache
   rm -rf /tmp/npm-global

EOF
}

################################################################################
# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
################################################################################
main() {
    echo ""
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë  Aleon's open-webui Codespace Setup (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ /tmp)       ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    
    check_storage
    setup_workspace
    setup_nodejs
    setup_python
    build_app
    create_startup_script
    print_summary
    
    log_success "–ì–æ—Ç–æ–≤–æ! –ò—Å–ø–æ–ª—å–∑—É–π /tmp/aleon-start.sh –¥–ª—è –∑–∞–ø—É—Å–∫–∞"
}

# –ó–∞–ø—É—Å–∫
main
